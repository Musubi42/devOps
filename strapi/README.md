## Requirements
Node 18
Docker && docker compose
Login to Docker hub (to store the image)
docker login --username <YOUR_USERNAME>

## Installation

Install STRAPI
```bash
npx create-strapi-app my-app-name --quickstart --template blog
```
Make the install with the quickstart option,
As I have tested so far, the only installation that is working, is with '--template blog`

This will generate this `.env` file :
```shell
HOST=0.0.0.0
PORT=1337
APP_KEYS=3FJyq16RLJStsEsBtTWR6w==,RUNxE2ZiLfuFPHvZVmdbfg==,mKll4Q8fi22JiSRRpBlA1Q==,T41GS4wje6JM5rgjSpRSLg==
API_TOKEN_SALT=hS3Wv4EWY7hP5a7k56hj9Q==
ADMIN_JWT_SECRET=FzIi8TzG22y1apt+YgF/6w==
TRANSFER_TOKEN_SALT=DU/OoOVfOUH+BoIBqUgGqg==
# Database
DATABASE_CLIENT=sqlite
DATABASE_FILENAME=.tmp/data.db
```

In the .env file, change the `DATABASE_CLIENT=sqlite` to `DATABASE_CLIENT=mysql2`


## Dockerfile

We need to create a Docker image of it
`Dockerfile`
```bash
FROM node:18-alpine
# Installing libvips-dev for sharp Compatibility
RUN apk update && apk add --no-cache build-base gcc autoconf automake zlib-dev libpng-dev nasm bash vips-dev git
ARG NODE_ENV=development
ENV NODE_ENV=${NODE_ENV}

WORKDIR /opt/
COPY package.json package-lock.json ./
RUN npm install -g node-gyp
RUN npm config set fetch-retry-maxtimeout 600000 -g && npm install
ENV PATH /opt/node_modules/.bin:$PATH

WORKDIR /opt/app
COPY . .
RUN chown -R node:node /opt/app
USER node
RUN ["npm", "run", "build"]
EXPOSE 1337
CMD ["npm", "run", "develop"]
```

We don't need certain elements, so we will ignore them
`.dockerignore`
```shell
.tmp/
.cache/
.git/
build/
node_modules/
data/
```

Now build the image
```bash
docker build -t <YOUR_IMAGE_NAME> .
```
`-t` gives a tag to image that will be build,
`.` specify the command to build from here

docker tag <YOUR_IMAGE_NAME> <YOUR_USERNAME>/<YOUR_DOCKER_HUB_REPO>

docker push <YOUR_USERNAME>/<YOUR_DOCKER_HUB_REPO>

## Docker compose
### Strapi & mysql & Traefik

docker-compose.yml
```shell 
version: "3"
services:
  strapi:
    container_name: strapi
    build: .
    image: <YOUR_BUILT_IMAGE>
    restart: unless-stopped
    env_file: .env
    environment:
      DATABASE_CLIENT: ${DATABASE_CLIENT}
      DATABASE_HOST: ${DATABASE_HOST}
      DATABASE_PORT: ${DATABASE_PORT}
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_JWT_SECRET: ${ADMIN_JWT_SECRET}
      APP_KEYS: ${APP_KEYS}
      NODE_ENV: ${NODE_ENV}
    volumes:
      - ./data:/opt/app/data
      - ./config:/opt/app/config
      - ./src:/opt/app/src
      - ./package.json:/opt/package.json
      - ./yarn.lock:/opt/yarn.lock
      - ./.env:/opt/app/.env
      - ./public/uploads:/opt/app/public/uploads
    labels:
      - traefik.enable=true
      - traefik.http.routers.strapi.rule=Host(`strapi.musubi.dev`)
      - traefik.http.routers.strapi.entrypoints=websecure
      - traefik.http.routers.strapi.tls.certresolver=letsencryptresolver
    networks:
      - strapi
      - traefik
    depends_on:
      - strapiDB

  strapiDB:
    container_name: strapiDB
    platform: linux/amd64 #for platform error on Apple M1 chips
    restart: unless-stopped
    env_file: .env
    image: mysql:8
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_USER: ${DATABASE_USERNAME}
      MYSQL_ROOT_PASSWORD: ${DATABASE_PASSWORD}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD}
      MYSQL_DATABASE: ${DATABASE_NAME}
    volumes:
      - strapi-data:/var/lib/mysql # The database volumes can't be in the same location as the Strapi, because the watch mode of Strapi, will keep refreshing the app, and so continuously restart Strapi
    networks:
      - strapi

volumes:
  strapi-data:

networks:
  strapi:
    name: Strapi
    driver: bridge
  traefik:
      name: traefik
      external: true
```

From the `.env` file generated by the Strapi installation, add the following variables :
- DATABASE_HOST=localhost
- DATABASE_PORT=3306
- DATABASE_NAME=<DATABASE_NAME>
- DATABASE_HOST=<DOCKER_SERVICE_NAME_OF_DB> # Example : strapiDB
- DATABASE_USERNAME=<DATABASE_USERNAME>
- DATABASE_PASSWORD=<DATABASE_PASSWORS>
- NODE_ENV=development

## Run Strapi
```shell
docker compose up
```


Go to `YOUR_DOMAIN/admin`

